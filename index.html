<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Exuberanza Festival Management</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Exuberanza">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        .hidden { display: none !important; }
        .modal-backdrop { background: rgba(0, 0, 0, 0.5); }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; }
        #qr-scanner-container { width: 100%; max-width: 350px; margin: 0 auto; }
        
        /* Mobile-first responsive design */
        .mobile-container { max-width: 100vw; overflow-x: hidden; }
        .mobile-header { position: sticky; top: 0; z-index: 40; }
        .mobile-content { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .tap-highlight { -webkit-tap-highlight-color: transparent; }
        .touch-action { touch-action: manipulation; }
        
        /* Competition card animations */
        .competition-card { transition: all 0.2s ease; }
        .competition-card:active { transform: scale(0.98); }
        
        /* Status indicators */
        .status-completed { background: linear-gradient(135deg, #10b981, #059669); }
        .status-active { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .status-pending { background: linear-gradient(135deg, #6b7280, #4b5563); }
        
        /* Install prompt and button styles */
        .install-prompt { 
            transform: translateY(100%); 
            transition: transform 0.3s ease; 
        }
        .install-prompt.show { transform: translateY(0); }
        
        .install-login-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
        }
        .install-login-btn:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }
        
        /* Custom scrollbar for mobile */
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen mobile-container">
    <!-- Mobile Header (Hidden on Login Page) -->
    <header id="mainHeader" class="mobile-header bg-white shadow-sm border-b">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img src="exuberanza.svg" alt="Exuberanza" class="h-8 w-auto">
                    <div id="headerTitle">
                        <h1 class="text-lg font-bold text-gray-800">Exuberanza</h1>
                    </div>
                </div>
                <button id="btn-logout" class="hidden bg-red-500 text-white px-3 py-1.5 rounded-md text-sm hover:bg-red-600 tap-highlight touch-action flex items-center space-x-1.5">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </header>

    <!-- PWA Install Prompt (Bottom Banner) -->
    <div id="installPrompt" class="install-prompt fixed bottom-0 left-0 right-0 bg-blue-600 text-white p-4 z-50">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="logo.png" alt="Install" class="w-8 h-8 rounded">
                <div>
                    <p class="font-medium text-sm">Install Exuberanza App</p>
                    <p class="text-xs opacity-90">Add to home screen for quick access</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="installBtn" class="bg-white text-blue-600 px-3 py-1 rounded text-sm font-medium tap-highlight touch-action">
                    Install
                </button>
                <button id="dismissInstall" class="text-white opacity-75 hover:opacity-100 tap-highlight touch-action">
                    ✕
                </button>
            </div>
        </div>
    </div>

    <!-- Authentication -->
    <div id="auth" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 mobile-content">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm mx-4 border border-gray-100">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <img src="exuberanza.svg" alt="Exuberanza" class="w-12 h-12 text-white">
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome</h2>
                <p class="text-gray-500 text-sm">Festival Management System</p>
            </div>
            
            <form id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                    <select id="role" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-action bg-gray-50">
                        <option value="admin">Admin</option>
                        <option value="leader">Team Leader</option>
                        <option value="invigilator">Invigilator</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Username/Stage Name</label>
                    <input type="text" id="username" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-action bg-gray-50" placeholder="Enter username or stage name">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent touch-action bg-gray-50" placeholder="Enter password">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-4 rounded-xl hover:from-blue-600 hover:to-indigo-700 font-semibold touch-action shadow-lg transition-all duration-200">
                    Login
                </button>
            </form>
            
            <!-- Install Button in Login Page -->
            <div id="loginInstallSection" class="mt-6 pt-6 border-t border-gray-100">
                <button id="loginInstallBtn" class="install-login-btn w-full text-white py-3 rounded-xl font-semibold touch-action flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Install App to Home Screen</span>
                </button>
                <p class="text-xs text-gray-500 text-center mt-2">Get the full native app experience</p>
            </div>
        </div>
    </div>

    <!-- Admin App -->
    <div id="admin-app" class="hidden mobile-content"></div>

    <!-- Leader App -->
    <div id="leader-app" class="hidden mobile-content"></div>

    <!-- Invigilator App -->
    <div id="invigilator-app" class="hidden mobile-content"></div>

    <!-- Alert Modal -->
    <div id="alertModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4">
            <div class="flex items-center mb-4">
                <div id="alertIcon" class="mr-3"></div>
                <h3 id="alertTitle" class="text-lg font-semibold"></h3>
            </div>
            <p id="alertMessage" class="text-gray-600 mb-6"></p>
            <button onclick="document.getElementById('alertModal').classList.add('hidden')" 
                    class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 touch-action">
                OK
            </button>
        </div>
    </div>

    <!-- Admin Modals -->
    <div id="adminModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="adminModalTitle" class="text-xl font-semibold"></h3>
                <button onclick="closeAdminModal()" class="text-gray-500 hover:text-gray-700 text-2xl touch-action">&times;</button>
            </div>
            <div id="adminModalContent"></div>
        </div>
    </div>

    <div id="adminBulkImportModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Bulk Import</h3>
                <button onclick="closeAdminBulkImportModal()" class="text-gray-500 hover:text-gray-700 text-2xl touch-action">&times;</button>
            </div>
            <div id="adminBulkImportContent"></div>
        </div>
    </div>

    <!-- Leader Modals -->
    <div id="leaderAssignModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="leaderAssignModalTitle" class="text-xl font-semibold"></h3>
                <button onclick="closeLeaderAssignModal()" class="text-gray-500 hover:text-gray-700 text-2xl touch-action">&times;</button>
            </div>
            <div id="leaderAssignModalContent"></div>
        </div>
    </div>

    <div id="leaderAlertModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4">
            <div class="flex items-center mb-4">
                <div id="leaderAlertIcon" class="mr-3"></div>
                <h3 id="leaderAlertTitle" class="text-lg font-semibold"></h3>
            </div>
            <p id="leaderAlertMessage" class="text-gray-600 mb-4"></p>
            <button onclick="document.getElementById('leaderAlertModal').classList.add('hidden')" 
                    class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 touch-action">
                OK
            </button>
        </div>
    </div>

    <!-- QR Code Modal for Invigilator -->
    <div id="qrModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-6xl mx-4 max-h-[95vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center rounded-t-xl">
                <h3 id="qrModalTitle" class="text-lg font-semibold truncate"></h3>
                <button onclick="closeQRModal()" class="text-gray-500 hover:text-gray-700 text-2xl touch-action">&times;</button>
            </div>
            <div id="qrModalContent" class="p-6"></div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">QR Code Scanner</h3>
                <button onclick="stopDirectScanning()" class="text-gray-500 hover:text-gray-700 text-2xl touch-action">&times;</button>
            </div>
            <div id="qr-scanner-container"></div>
        </div>
    </div>

    <script>
        // PWA Install functionality
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt banner
            document.getElementById('installPrompt').classList.add('show');
            
            // Show install button in login page
            document.getElementById('loginInstallSection').style.display = 'block';
        });

        // Install button in banner
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
                
                if (window.hapticFeedback) window.hapticFeedback('success');
            }
        });

        // Install button in login page
        document.getElementById('loginInstallBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
                document.getElementById('loginInstallSection').style.display = 'none';
                
                if (window.hapticFeedback) window.hapticFeedback('success');
            } else {
                // Fallback for browsers that don't support beforeinstallprompt
                showAlert('To install this app:\n\n• On iOS: Tap Share → Add to Home Screen\n• On Android: Tap Menu → Add to Home Screen', 'info');
            }
        });

        // Dismiss install prompt
        document.getElementById('dismissInstall').addEventListener('click', () => {
            document.getElementById('installPrompt').classList.remove('show');
            if (window.hapticFeedback) window.hapticFeedback('light');
        });

        // Hide install prompt when app is installed
        window.addEventListener('appinstalled', () => {
            document.getElementById('installPrompt').classList.remove('show');
            document.getElementById('loginInstallSection').style.display = 'none';
            deferredPrompt = null;
            if (window.hapticFeedback) window.hapticFeedback('success');
        });

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => console.log('SW registered'))
                .catch((error) => console.log('SW registration failed'));
        }

        // Haptic feedback utility
        function hapticFeedback(type = 'light') {
            if ('vibrate' in navigator) {
                switch(type) {
                    case 'light': navigator.vibrate(10); break;
                    case 'medium': navigator.vibrate(20); break;
                    case 'heavy': navigator.vibrate([10, 10, 10]); break;
                    case 'success': navigator.vibrate([100, 50, 100]); break;
                    case 'error': navigator.vibrate([200, 100, 200]); break;
                    default: navigator.vibrate(10);
                }
            }
        }

        // Make haptic feedback globally available
        window.hapticFeedback = hapticFeedback;

        // Hide install section initially
        document.getElementById('loginInstallSection').style.display = 'none';
    </script>

    <script src="utils.js"></script>
    <script src="app.js"></script>
    <script src="admin.js"></script>
    <script src="leader.js"></script>
    <script src="invigilator.js"></script>
</body>
</html>
